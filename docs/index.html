<!-- ===== Exam Bank (shuffled + timer + saved scores) ===== -->
<details open>
  <summary><b>üìù Exam Bank (interactive)</b></summary>
  <div style="margin:12px 0; padding:10px; border:1px solid #e5e7eb; border-radius:10px">
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center">
      <label>Mode:
        <select id="qb-mode">
          <option value="mcq">MCQ</option>
          <option value="fill">Fill-in</option>
          <option value="mix">Mixed</option>
        </select>
      </label>
      <label>Level:
        <select id="qb-level">
          <option value="ALL">All</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </label>
      <label>Number:
        <select id="qb-count">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="150">All</option>
        </select>
      </label>
      <label>Timer:
        <select id="qb-timer">
          <option value="0" selected>No timer</option>
          <option value="300">5 min</option>
          <option value="600">10 min</option>
          <option value="1200">20 min</option>
          <option value="1800">30 min</option>
        </select>
      </label>
      <button id="qb-start">Start Quiz</button>
      <button id="qb-reset-best" title="Clear best score (this device only)">Reset best</button>
    </div>

    <div id="qb-status" style="margin:8px 0; color:#6b7280"></div>
    <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap">
      <div id="qb-timer-readout" style="font-weight:600; color:#111827"></div>
      <div id="qb-best" style="color:#6b7280"></div>
    </div>

    <div id="qb-area" style="margin-top:10px"></div>
  </div>
</details>

<script>
(function(){
  const area = document.getElementById('qb-area');
  const statusEl = document.getElementById('qb-status');
  const btnStart = document.getElementById('qb-start');
  const btnResetBest = document.getElementById('qb-reset-best');
  const selMode = document.getElementById('qb-mode');
  const selLevel = document.getElementById('qb-level');
  const selCount = document.getElementById('qb-count');
  const selTimer = document.getElementById('qb-timer');
  const timerReadout = document.getElementById('qb-timer-readout');
  const bestBox = document.getElementById('qb-best');

  const STORE_KEY = 'neuroexam_scores_v1';
  let BANK = [];
  let quiz = null;
  let timer = {secs:0, id:null, running:false};

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function shuffleOptions(q){
    // returns a copy with options shuffled and answer reindexed
    const idxs = q.options.map((_,i)=>i);
    shuffle(idxs);
    const newOptions = idxs.map(i=>q.options[i]);
    const newAnswer = idxs.indexOf(q.answer);
    return {...q, options:newOptions, answer:newAnswer};
  }

  function pickQuestions(level, count){
    let pool = (level==='ALL') ? BANK : BANK.filter(q=>q.level===level);
    pool = shuffle(pool.slice()); // shuffle question order
    if(count>pool.length) count = pool.length;
    // shuffle options for each q
    return pool.slice(0, count).map(shuffleOptions);
  }

  function renderMCQ(q, idx){
    const opts = q.options.map((t,i)=>`
      <label style="display:block;margin:6px 0">
        <input type="radio" name="q${idx}" value="${i}"> ${String.fromCharCode(65+i)}. ${t}
      </label>`).join('');
    return `<div class="q" data-id="${q.id}" data-ans="${q.answer}">
      <div><b>Q${idx+1}.</b> ${q.stem}</div>
      <div style="margin-top:6px">${opts}</div>
    </div>`;
  }

  function renderFill(q, idx){
    return `<div class="q" data-id="${q.id}" data-ans="${q.answer}">
      <div><b>Q${idx+1}.</b> ${q.stem}</div>
      <div style="margin-top:6px">
        <input type="text" name="q${idx}" placeholder="Type the correct option text‚Ä¶" style="width:100%;max-width:520px">
        <div style="color:#6b7280;font-size:.9rem;margin-top:4px">Hint: match one of the options exactly (case-insensitive).</div>
      </div>
    </div>`;
  }

  function keyForBest(mode, level){
    return `best_${mode}_${level}`;
  }

  function loadScores(){
    try { return JSON.parse(localStorage.getItem(STORE_KEY)||'{}'); }
    catch(e){ return {}; }
  }
  function saveScores(obj){
    localStorage.setItem(STORE_KEY, JSON.stringify(obj));
  }
  function getBest(mode, level){
    const s = loadScores();
    return s[keyForBest(mode, level)] || null;
  }
  function setBest(mode, level, pct){
    const s = loadScores();
    const key = keyForBest(mode, level);
    if(!s[key] || pct > s[key].pct){
      s[key] = { pct, at: Date.now() };
      saveScores(s);
    }
  }
  function resetBest(){
    const s = loadScores();
    const keys = Object.keys(s).filter(k=>k.startsWith('best_'));
    keys.forEach(k=>delete s[k]);
    saveScores(s);
    updateBestDisplay();
  }
  function updateBestDisplay(){
    const b = getBest(selMode.value, selLevel.value);
    bestBox.textContent = b ? `Best (${selMode.value}/${selLevel.value}): ${b.pct}%` : `Best (${selMode.value}/${selLevel.value}): ‚Äî`;
  }

  function startTimer(seconds){
    stopTimer();
    if(seconds<=0){ timerReadout.textContent = ''; return; }
    timer.secs = seconds;
    timer.running = true;
    timerReadout.textContent = fmt(timer.secs);
    timer.id = setInterval(()=>{
      timer.secs--;
      timerReadout.textContent = fmt(timer.secs);
      if(timer.secs<=0){
        stopTimer();
        autoSubmit();
      }
    }, 1000);
  }
  function stopTimer(){
    if(timer.id){ clearInterval(timer.id); timer.id=null; }
    timer.running=false;
  }
  function fmt(s){
    const m = Math.floor(s/60), ss = s%60;
    return `‚è≥ ${m}:${ss.toString().padStart(2,'0')}`;
  }

  function startQuiz(){
    const mode = selMode.value;           // mcq | fill | mix
    const level = selLevel.value;         // ALL | A | B | C
    const req = parseInt(selCount.value,10);
    const sec = parseInt(selTimer.value,10);

    const qs = pickQuestions(level, req);
    quiz = { mode, level, qs, started: Date.now(), submitted:false };

    statusEl.textContent = `Loaded ${qs.length} questions (Level: ${level}, Mode: ${mode}).`;
    updateBestDisplay();

    const blocks = qs.map((q,i)=>{
      const m = (mode==='mix') ? (Math.random()<0.5?'mcq':'fill') : mode;
      return (m==='mcq') ? renderMCQ(q,i) : renderFill(q,i);
    }).join('<hr>');

    area.innerHTML = blocks + `
      <div style="margin-top:12px">
        <button id="qb-submit">Submit</button>
        <button id="qb-restart" style="margin-left:8px">Restart</button>
        <span id="qb-score" style="margin-left:12px;color:#6b7280"></span>
      </div>
    `;

    document.getElementById('qb-submit').onclick = gradeQuiz;
    document.getElementById('qb-restart').onclick = startQuiz;

    startTimer(sec);
  }

  function autoSubmit(){
    const submitBtn = document.getElementById('qb-submit');
    if(submitBtn){ submitBtn.click(); }
  }

  function gradeQuiz(){
    if(!quiz || quiz.submitted) return;
    stopTimer();
    quiz.submitted = true;

    const blocks = Array.from(area.querySelectorAll('.q'));
    let correct = 0;
    blocks.forEach((b, idx)=>{
      const ans = parseInt(b.dataset.ans,10);
      const q = quiz.qs[idx];
      const radios = b.querySelectorAll('input[type=radio]');
      const text = b.querySelector('input[type=text]');
      let ok = false;
      if(radios.length){
        const chosen = Array.from(radios).find(r=>r.checked);
        ok = chosen && parseInt(chosen.value,10)===ans;
      }else if(text){
        const want = q.options[ans].trim().toLowerCase();
        const got = (text.value||'').trim().toLowerCase();
        ok = (got===want);
      }
      if(ok){ correct++; b.style.background='#ecfdf5'; } else { b.style.background='#fef2f2'; }
    });
    const pct = Math.round(100*correct/blocks.length);
    document.getElementById('qb-score').textContent = `Score: ${correct}/${blocks.length} (${pct}%)`;
    statusEl.textContent = `Finished. You scored ${pct}%.`;

    // Save best (per current mode + level) in this browser only
    setBest(selMode.value, selLevel.value, pct);
    updateBestDisplay();
  }

  btnStart.onclick = startQuiz;
  btnResetBest.onclick = resetBest;

  // Load question bank
  fetch('questions.json', {cache:'no-store'})
    .then(r=>r.json())
    .then(j=>{
      BANK = j.questions || [];
      statusEl.textContent = `Question bank loaded: ${BANK.length} items. Choose options and click ‚ÄúStart Quiz‚Äù.`;
      updateBestDisplay();
    })
    .catch(e=>{
      statusEl.textContent = 'Failed to load questions.json: '+e.message;
    });

  // Update displayed "Best" when selectors change
  [selMode, selLevel].forEach(el=>el.addEventListener('change', updateBestDisplay));
})();
</script>
